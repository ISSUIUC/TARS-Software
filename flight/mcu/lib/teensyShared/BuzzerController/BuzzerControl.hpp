#ifndef BUZZER_CONTROL_H
#define BUZZER_CONTROL_H

#include "dataLog.h"
#include "acShared.h"

// the following table should be generated by beep_fsm_gen.py
// TODO this doesn't need a full fsm, we can get away with a struct of a sequence and a "should_loop" parameter
// TODO it would make the code a lot simpler and more comprehensible
/* ======= AUTOGENERATED ======= */

enum BuzzerState {
    INITIAL,
    BUZZ_IDLE_STATE_0,
    BUZZ_IDLE_STATE_1,
    BUZZ_IDLE_STATE_2,
    BUZZ_IDLE_STATE_3,
    BUZZ_IDLE_STATE_4,
    BUZZ_IDLE_STATE_5,
    BUZZ_IDLE_STATE_6,
    BUZZ_IDLE_STATE_7,
    BUZZ_BOOST_STATE_0,
    BUZZ_BOOST_STATE_1,
    BUZZ_BOOST_STATE_2,
    BUZZ_BOOST_STATE_3,
    BUZZ_BOOST_STATE_4,
    BUZZ_BOOST_STATE_5,
    BUZZ_BOOST_STATE_6,
    BUZZ_BOOST_STATE_7,
    BUZZ_COAST_STATE_0,
    BUZZ_COAST_STATE_1,
    BUZZ_COAST_STATE_2,
    BUZZ_COAST_STATE_3,
    BUZZ_COAST_STATE_4,
    BUZZ_COAST_STATE_5,
    BUZZ_COAST_STATE_6,
    BUZZ_COAST_STATE_7,
    BUZZ_APOGEE_STATE_0,
    BUZZ_APOGEE_STATE_1,
    BUZZ_APOGEE_STATE_2,
    BUZZ_APOGEE_STATE_3,
    BUZZ_APOGEE_STATE_4,
    BUZZ_APOGEE_STATE_5,
    BUZZ_APOGEE_STATE_6,
    BUZZ_APOGEE_STATE_7,
    BUZZ_DROGUE_STATE_0,
    BUZZ_DROGUE_STATE_1,
    BUZZ_DROGUE_STATE_2,
    BUZZ_DROGUE_STATE_3,
    BUZZ_DROGUE_STATE_4,
    BUZZ_DROGUE_STATE_5,
    BUZZ_DROGUE_STATE_6,
    BUZZ_DROGUE_STATE_7,
    BUZZ_MAIN_STATE_0,
    BUZZ_MAIN_STATE_1,
    BUZZ_MAIN_STATE_2,
    BUZZ_MAIN_STATE_3,
    BUZZ_MAIN_STATE_4,
    BUZZ_MAIN_STATE_5,
    BUZZ_MAIN_STATE_6,
    BUZZ_MAIN_STATE_7,
    BUZZ_LANDED_STATE_0,
    BUZZ_LANDED_STATE_1,
    BUZZ_LANDED_STATE_2,
    BUZZ_LANDED_STATE_3,
    BUZZ_LANDED_STATE_4,
    BUZZ_LANDED_STATE_5,
    BUZZ_LANDED_STATE_6,
    BUZZ_LANDED_STATE_7,
    BUZZ_ABORT_STATE_0,
    BUZZ_ABORT_STATE_1,
    BUZZ_ABORT_STATE_2,
    BUZZ_ABORT_STATE_3,
    BUZZ_ABORT_STATE_4,
    BUZZ_ABORT_STATE_5,
    BUZZ_ABORT_STATE_6,
    BUZZ_ABORT_STATE_7,
};

unsigned int BuzzerStates[65][3] = {
    /* INITIAL*/ {0, 0, INITIAL},
    /* BUZZ_IDLE_STATE_0 */ { 1000, 250, BUZZ_IDLE_STATE_1 },
    /* BUZZ_IDLE_STATE_1 */ { 0, 500, BUZZ_IDLE_STATE_2 },
    /* BUZZ_IDLE_STATE_2 */ { 500, 250, BUZZ_IDLE_STATE_3 },
    /* BUZZ_IDLE_STATE_3 */ { 0, 500, BUZZ_IDLE_STATE_4 },
    /* BUZZ_IDLE_STATE_4 */ { 500, 250, BUZZ_IDLE_STATE_5 },
    /* BUZZ_IDLE_STATE_5 */ { 0, 500, BUZZ_IDLE_STATE_6 },
    /* BUZZ_IDLE_STATE_6 */ { 500, 750, BUZZ_IDLE_STATE_7 },
    /* BUZZ_IDLE_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_BOOST_STATE_0 */ { 1000, 250, BUZZ_BOOST_STATE_1 },
    /* BUZZ_BOOST_STATE_1 */ { 0, 500, BUZZ_BOOST_STATE_2 },
    /* BUZZ_BOOST_STATE_2 */ { 500, 250, BUZZ_BOOST_STATE_3 },
    /* BUZZ_BOOST_STATE_3 */ { 0, 500, BUZZ_BOOST_STATE_4 },
    /* BUZZ_BOOST_STATE_4 */ { 500, 750, BUZZ_BOOST_STATE_5 },
    /* BUZZ_BOOST_STATE_5 */ { 0, 500, BUZZ_BOOST_STATE_6 },
    /* BUZZ_BOOST_STATE_6 */ { 500, 250, BUZZ_BOOST_STATE_7 },
    /* BUZZ_BOOST_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_COAST_STATE_0 */ { 1000, 250, BUZZ_COAST_STATE_1 },
    /* BUZZ_COAST_STATE_1 */ { 0, 500, BUZZ_COAST_STATE_2 },
    /* BUZZ_COAST_STATE_2 */ { 500, 250, BUZZ_COAST_STATE_3 },
    /* BUZZ_COAST_STATE_3 */ { 0, 500, BUZZ_COAST_STATE_4 },
    /* BUZZ_COAST_STATE_4 */ { 500, 750, BUZZ_COAST_STATE_5 },
    /* BUZZ_COAST_STATE_5 */ { 0, 500, BUZZ_COAST_STATE_6 },
    /* BUZZ_COAST_STATE_6 */ { 500, 750, BUZZ_COAST_STATE_7 },
    /* BUZZ_COAST_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_APOGEE_STATE_0 */ { 1000, 250, BUZZ_APOGEE_STATE_1 },
    /* BUZZ_APOGEE_STATE_1 */ { 0, 500, BUZZ_APOGEE_STATE_2 },
    /* BUZZ_APOGEE_STATE_2 */ { 500, 750, BUZZ_APOGEE_STATE_3 },
    /* BUZZ_APOGEE_STATE_3 */ { 0, 500, BUZZ_APOGEE_STATE_4 },
    /* BUZZ_APOGEE_STATE_4 */ { 500, 250, BUZZ_APOGEE_STATE_5 },
    /* BUZZ_APOGEE_STATE_5 */ { 0, 500, BUZZ_APOGEE_STATE_6 },
    /* BUZZ_APOGEE_STATE_6 */ { 500, 250, BUZZ_APOGEE_STATE_7 },
    /* BUZZ_APOGEE_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_DROGUE_STATE_0 */ { 1000, 250, BUZZ_DROGUE_STATE_1 },
    /* BUZZ_DROGUE_STATE_1 */ { 0, 500, BUZZ_DROGUE_STATE_2 },
    /* BUZZ_DROGUE_STATE_2 */ { 500, 750, BUZZ_DROGUE_STATE_3 },
    /* BUZZ_DROGUE_STATE_3 */ { 0, 500, BUZZ_DROGUE_STATE_4 },
    /* BUZZ_DROGUE_STATE_4 */ { 500, 250, BUZZ_DROGUE_STATE_5 },
    /* BUZZ_DROGUE_STATE_5 */ { 0, 500, BUZZ_DROGUE_STATE_6 },
    /* BUZZ_DROGUE_STATE_6 */ { 500, 750, BUZZ_DROGUE_STATE_7 },
    /* BUZZ_DROGUE_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_MAIN_STATE_0 */ { 1000, 250, BUZZ_MAIN_STATE_1 },
    /* BUZZ_MAIN_STATE_1 */ { 0, 500, BUZZ_MAIN_STATE_2 },
    /* BUZZ_MAIN_STATE_2 */ { 500, 750, BUZZ_MAIN_STATE_3 },
    /* BUZZ_MAIN_STATE_3 */ { 0, 500, BUZZ_MAIN_STATE_4 },
    /* BUZZ_MAIN_STATE_4 */ { 500, 750, BUZZ_MAIN_STATE_5 },
    /* BUZZ_MAIN_STATE_5 */ { 0, 500, BUZZ_MAIN_STATE_6 },
    /* BUZZ_MAIN_STATE_6 */ { 500, 250, BUZZ_MAIN_STATE_7 },
    /* BUZZ_MAIN_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_LANDED_STATE_0 */ { 1000, 250, BUZZ_LANDED_STATE_1 },
    /* BUZZ_LANDED_STATE_1 */ { 0, 500, BUZZ_LANDED_STATE_2 },
    /* BUZZ_LANDED_STATE_2 */ { 500, 750, BUZZ_LANDED_STATE_3 },
    /* BUZZ_LANDED_STATE_3 */ { 0, 500, BUZZ_LANDED_STATE_4 },
    /* BUZZ_LANDED_STATE_4 */ { 500, 750, BUZZ_LANDED_STATE_5 },
    /* BUZZ_LANDED_STATE_5 */ { 0, 500, BUZZ_LANDED_STATE_6 },
    /* BUZZ_LANDED_STATE_6 */ { 500, 750, BUZZ_LANDED_STATE_7 },
    /* BUZZ_LANDED_STATE_7 */ { 0, 500, INITIAL },
    /* BUZZ_ABORT_STATE_0 */ { 1000, 750, BUZZ_ABORT_STATE_1 },
    /* BUZZ_ABORT_STATE_1 */ { 0, 500, BUZZ_ABORT_STATE_2 },
    /* BUZZ_ABORT_STATE_2 */ { 500, 250, BUZZ_ABORT_STATE_3 },
    /* BUZZ_ABORT_STATE_3 */ { 0, 500, BUZZ_ABORT_STATE_4 },
    /* BUZZ_ABORT_STATE_4 */ { 500, 250, BUZZ_ABORT_STATE_5 },
    /* BUZZ_ABORT_STATE_5 */ { 0, 500, BUZZ_ABORT_STATE_6 },
    /* BUZZ_ABORT_STATE_6 */ { 500, 250, BUZZ_ABORT_STATE_7 },
    /* BUZZ_ABORT_STATE_7 */ { 0, 500, INITIAL },
};

/* ======= END AUTOGENERATED ======= */

class BuzzerController {
public:
    explicit BuzzerController(pointers *);

    void tickBuzzer();
    void setBuzzerState(BuzzerState state);

private:
    BuzzerState curr_state;
    unsigned long time_since_state_start;

    pointers* rocket_state;
    FSM_State last_rocket_fsm_state;
};


#endif